<!DOCTYPE html>
<html lang="en"><head><title>aes67 receiver</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM Plex Mono&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:title" content="aes67 receiver"/><meta property="og:description" content="these are mostly notes for myself so far, not any sort of writeup that’s supposed to be legible. enjoy if you dare! RasPi-based prototype Hardware Raspberry Pi Compute Module 4, which has an Ethernet MAC that supports the necessary timestamping for IEEE 1588 the 1GB RAM, 8GB eMMC, no wifi variant."/><meta property="og:image" content="https://jessie.grosen.systems/static/og-image.png"/><meta property="og:width" content="1200"/><meta property="og:height" content="675"/><link rel="icon" href="../static/icon.png"/><meta name="description" content="these are mostly notes for myself so far, not any sort of writeup that’s supposed to be legible. enjoy if you dare! RasPi-based prototype Hardware Raspberry Pi Compute Module 4, which has an Ethernet MAC that supports the necessary timestamping for IEEE 1588 the 1GB RAM, 8GB eMMC, no wifi variant."/><meta name="generator" content="Quartz"/><link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../static/contentIndex.json").then(data => data.json())</script></head><body data-slug="projects/aes67-receiver"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href="..">it's jessie</a></h2><div class="spacer mobile-only"></div><div class="explorer desktop-only"><span id="explorer" data-behavior="collapse" data-collapsed="collapsed" data-savestate="false" data-tree="[{&quot;path&quot;:&quot;interests&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;interests/transit&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;interests/transit/nyc&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;posts&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;projects&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;projects/miscellanea&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;talks&quot;,&quot;collapsed&quot;:true}]"></span><div id="explorer-content"><ul class id="explorer-ul"><li><div class="folder-outer open"><ul style="padding-left:0;" class="content" data-folderul><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="interests"><button class="folder-button"><span class="folder-title">interests</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="interests"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="interests/transit"><button class="folder-button"><span class="folder-title">transit</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="interests/transit"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="interests/transit/nyc"><button class="folder-button"><span class="folder-title">nyc</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="interests/transit/nyc"><li><a href="../interests/transit/nyc/R211T" data-for="interests/transit/nyc/R211T">R211T</a></li></ul></div></li></ul></div></li></ul></div></li><li><div class="folder-outer open"><ul style="padding-left:0;" class="content" data-folderul></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="posts"><button class="folder-button"><span class="folder-title">posts</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="posts"><li><a href="../posts/distance-audio-modulator" data-for="posts/distance-audio-modulator">distance audio modulator</a></li><li><a href="../posts/i-think-i'm-beginning-to-recover" data-for="posts/i-think-i'm-beginning-to-recover">i think i'm beginning to recover</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="projects"><button class="folder-button"><span class="folder-title">projects</span></button></div></div><div class="folder-outer open"><ul style="padding-left:1.4rem;" class="content" data-folderul="projects"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="projects/miscellanea"><button class="folder-button"><span class="folder-title">miscellanea</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="projects/miscellanea"><li><a href="../projects/miscellanea/crashing-waves" data-for="projects/miscellanea/crashing-waves">crashing waves</a></li><li><a href="../projects/miscellanea/Zoom-G1Xon-control" data-for="projects/miscellanea/Zoom-G1Xon-control">Zoom G1Xon control</a></li></ul></div></li><li><a href="../projects/aes67-receiver" data-for="projects/aes67-receiver">aes67 receiver</a></li><li><a href="../projects/folk-music" data-for="projects/folk-music">folk music</a></li><li><a href="../projects/hyperscale" data-for="projects/hyperscale">Hyperscale</a></li><li><a href="../projects/mta-projection" data-for="projects/mta-projection">mta projection</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="talks"><button class="folder-button"><span class="folder-title">talks</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="talks"><li><a href="../talks/mustard-watches" data-for="talks/mustard-watches">mustard watches</a></li></ul></div></li></ul></div></li><li id="explorer-end"></li></ul></div></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../projects/">projects</a></div></nav><h1 class="article-title">aes67 receiver</h1><p show-comma="false" class="status"><span>Status: prototyping</span></p><p show-comma="true" class="content-meta"><span>Sep 07, 2024</span></p></div></div><article class="popover-hint"><p>these are mostly notes for myself so far, not any sort of writeup that’s supposed to be legible. enjoy if you dare!</p>
<h1 id="raspi-based-prototype">RasPi-based prototype<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#raspi-based-prototype" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="hardware">Hardware<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#hardware" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li>Raspberry Pi Compute Module 4, which has an Ethernet MAC that supports the necessary timestamping for IEEE 1588
<ul>
<li>the 1GB RAM, 8GB eMMC, no wifi variant.</li>
</ul>
</li>
<li><a href="https://www.waveshare.com/wiki/CM4-NANO-B" class="external">Waveshare CM4-NANO-B<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> carrier board, which has both an Ethernet port and an audio jack (just driven off of the Pi’s PWM, so surely shitty audio, but good enough for testing).</li>
</ul>
<h2 id="software">Software<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#software" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Using <a href="https://gitlab.freedesktop.org/pipewire/pipewire/-/wikis/AES67" class="external">Pipewire’s preliminary AES67 support<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.</p>
<h3 id="setting-up-the-pi">Setting up the Pi<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#setting-up-the-pi" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Use the Raspberry Pi OS Lite image; I used specifically <a href="https://downloads.raspberrypi.com/raspios_lite_armhf/images/raspios_lite_armhf-2024-07-04/2024-07-04-raspios-bookworm-armhf-lite.img.xz" class="external">the 32-bit July 4th 2024 build<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> (should I have used a 64-bit build?). If the Pi eMMC is empty (as it is the first time you connect it), it will show up as a USB mass storage device immediately. However, once you flash something, you need to use the <a href="https://github.com/raspberrypi/usbboot" class="external">rpiboot utility from the raspi usbboot repo<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> in order to get it to show up as a mass storage device, even once you switch the CM4-NANO-B into boot mode. <a href="https://www.raspberrypi.com/documentation/computers/configuration.html#remote-access" class="external">Add an empty “ssh” file and a “userconf” file with contents <code>user:$(echo pass | openssl passwd -6 -stdin)</code><svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> to the boot volume (if you do this before ever booting you won’t need to use the rpiboot utility). mDNS is enabled for hostname <code>raspberrypi</code> by default.</p>
<p>To enable the shitty PWM-based audio, adapting from <a href="https://www.waveshare.com/wiki/CM4-NANO-B#Audio_Jack" class="external">the wiki page for the carrier board<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>, add <code>dtoverlay=audremap,pins_18_19</code> to the bottom of <code>/boot/firmware/config.txt</code> (ensure that <code>dtparam=audio=on</code> is already there; if not, add it). Reboot. Test it with <code>aplay -L</code> to confirm “bcm2835 headphones” is listed as a card, then plug in some headphones and play a wav with <code>aplay foo.wav</code>.</p>
<h3 id="setting-up-pipewire">Setting up Pipewire<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#setting-up-pipewire" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>We need a fairly recent Pipewire (at least, say, 1.2), beyond that which is available in Bookworm, the version of Debian that the Raspberry Pi OS I’m using is based on. So we need to use the version from bookworm-backports, first adding the Debian signing key since it’s different from Raspbian’s:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://ftp-master.debian.org/keys/archive-key-12.asc</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> archive-key-12.asc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apt/trusted.gpg.d/debian-bookworm-archive.asc</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://deb.debian.org/debian</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bookworm-backports</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> main</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apt/sources.list.d/backports.list</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bookworm-backports</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pipewire</span></span></code></pre></figure>
<p>We need to set up ptp4l to do timesyncing. For now we don’t have any other possible grandmasters on the network, so we’ll keep the default config that allows the Pi to act as grandmaster.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> linuxptp</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'KERNEL==&quot;ptp[0-9]*&quot;, MODE=&quot;0644&quot;'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/udev/rules.d/90-pipewire-aes67-ptp.rules</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ptp4l@eth0.service</span></span></code></pre></figure>
<p>Then set up Pipewire’s actual AES67 support, by putting <a href="https://gist.github.com/jmgrosen/fb214bb9fe36b27a8847b99c6590eb49" class="external">this configuration<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> in <code>~/.config/pipewire/pipewire.conf.d/10-aes67.conf</code></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.config/pipewire/pipewire.conf.d</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.config/pipewire/pipewire.conf.d</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://gist.githubusercontent.com/jmgrosen/fb214bb9fe36b27a8847b99c6590eb49/raw/7774310bcb8c698beda33b644f22d4e348f34446/10-aes67.conf</span></span></code></pre></figure>
<p>Add <code>threadirqs</code> to kernel command line <code>/boot/firmware/cmdline.txt</code>.</p>
<p>Unfortunately the builtin PWM-based audio driver for the Pi requires <em>very</em> large period sizes (1024), so the lowest latency we seem to be able to get is about 46ms (<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1024/48000</span></span></span></span>). We will in fact need a different DAC to get decent latency.</p>
<h1 id="host-audio-drivers">Host Audio Drivers<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#host-audio-drivers" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="linux">Linux<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#linux" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>The Pipewire AES67 support seems to work pretty well. There’s also <a href="https://github.com/bondagit/aes67-linux-daemon?tab=readme-ov-file" class="external">an ALSA driver<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> that I haven’t tried.</p>
<h2 id="macos">macOS<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#macos" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>The <a href="https://www.merging.com/products/aes67-vad" class="external">Merging RAVENNA/AES67 Virtual Audio Device<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> seems to be the main driver. It used to be available for free, but now it’s $50. An even bigger issue is that it causes my laptop to kernel panic frequently, making it really a nonstarter for actual use. Might be good enough for testing, though. Follow <a href="https://www.merging.com/uploads/assets/Installers/ravenna/Configure%20Merging%20and%20AES67%20Devices.pdf" class="external">this guide<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> to configure SAP announcements (in addition to the built-in RAVENNA (mDNS) announcements) that Pipewire can look for.</p>
<h3 id="so-im-working-on-my-own">so i’m working on my own<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#so-im-working-on-my-own" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<h4 id="2024-10-12">2024-10-12<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2024-10-12" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h4>
<p>working on the ptp implementation around statime. macos doesn’t seem to have a way to actually use any available hardware timestamping of ethernet interfaces? at least from userspace. it has the normal SO_TIMESTAMP (and mach_absolute_time-based SO_TIMESTAMP_MONOTONIC) for doing software timestamping on receives though. for now for TX timestamps i’ll just timestamp when a packet goes out from my code and eventually change to using the ptpd approach of using the multicast loopback receive to get the TX timestamp a bit closer to the metal.</p>
<p>do i have to make a shared-reference version of OverlayClock? probably</p>
<p>got frustrated.</p>
<h2 id="links">Links<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#links" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>to set dscp value correctly in the packets from the driver: <a href="https://gitlab.freedesktop.org/pipewire/pipewire/-/blob/master/src/modules/module-rtp-sink.c" class="external">https://gitlab.freedesktop.org/pipewire/pipewire/-/blob/master/src/modules/module-rtp-sink.c<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p>
<h1 id="stm32-based-prototype">STM32-based prototype<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#stm32-based-prototype" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<p>got a Nucleo-F767ZI. got an STM32F7-based board because that’s what the statime-stm32 example uses.</p>
<p>also got a <a href="https://shop.pimoroni.com/products/pico-audio-pack?variant=32369490853971" class="external">pimoroni pico audio kit<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> because that seemed like the simplest/cheapest i2s dac board that microcenter had with a jack rather than speaker amplifier.</p>
<h2 id="2024-10-12-1">2024-10-12<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2024-10-12-1" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>hooked together the Nucleo and pimoroni kit:
<img src="../public-media/aes67-receiver/pico-audio-kit-pinout.webp" width="auto" height="auto" alt/></p>
<ul>
<li>VSYS <span>←</span>> 5V</li>
<li>GND <span>←</span>> GND</li>
<li>MUTE <span>←</span>> CN8_16/D50/PG3</li>
<li>I2S_DATA <span>←</span>> CN7_3/D17/I2S_A_SD/PB15</li>
<li>I2S_BCK <span>←</span>> CN10_?/D?/?/PB10 (originally CN7_5/D18/I2S_A_CK/PB13 but that conflicts with ethernet pins)</li>
<li>I2S_LRCK <span>←</span>> CN7_7/D19/I2S_A_WS/PB12</li>
</ul>
<h2 id="2024-10-13">2024-10-13<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2024-10-13" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>trying to figure out how to do I2S on the STM32F7 from Rust. it seems like it’s not supported in stm32f7xx-hal, but the I2S peripheral on the stm32f7 is almost identical to that on the stm32f4, so hopefully we can steal some of the code from stm32f4xx-hal.</p>
<p>i realized the microusb cable i took home from resistor is power-only. rip.</p>
<h2 id="2024-10-14">2024-10-14<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2024-10-14" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>at resistor, equipped with a proper microusb cable, i was able to program the board with statime-stm32 and receive ptp packets! however, i couldn’t get lawo vsc to synchronize with it… i’m not sure whether this is due to some big problem or the ptp profile probably not being set correctly in statime-stm32. the logs for lawo vsc say “cannot use PTP <span>⇒</span> T1 value differs too much”.</p>
<p>i don’t think it’s just the port config. i changed the values to match those from the aes67 spec with no difference observed. i don’t see <em>any</em> ptp packets coming from my laptop, though, which seems very odd? it’s not, like, sending them at a level too low for wireshark to see, is it?</p>
<p>i guess i’ll switch to getting i2s to work.</p>
<p>oh, it does sync with ptpd on my laptop, though! encouraging!</p>
<h2 id="2024-10-19">2024-10-19<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2024-10-19" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>making progress on setting up the i2s in stm32f7xx-hal…</p>
<p>i was worried that i might not be able to get intra-sample phase sync (though it’s unclear how important that really is anyway…) due to not being able to “nudge” the i2s pll or in general control its phase, but then i realized that we’ll typically run the actual pll <em>a lot</em> faster than the i2s bit clock and so <a href="https://community.st.com/t5/stm32-mcus-products/synchronize-peripherals-sai-amp-i2s-output-clocks/m-p/718797/highlight/true#M260498" class="external">we can set the phase by controlling when exactly we enable the bit clock<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. that means we should have like 10-100ns accuracy (at the example i2s clk frequency of ~61MHz) assuming we can work out the interrupts nicely.</p>
<p>… but of course we can’t control the precise frequency of the i2s plls across devices so what good is that. it doesn’t look like there’s an easy way to nudge the pll…</p>
<h2 id="2024-10-25">2024-10-25<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2024-10-25" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>perhaps the stm32h7 has more appropriate PLLs? <a href="https://community.st.com/t5/stm32-mcus-embedded-software/pll-anybody-using-the-internal-plls-as-vco-for-audio/td-p/145437" class="external">https://community.st.com/t5/stm32-mcus-embedded-software/pll-anybody-using-the-internal-plls-as-vco-for-audio/td-p/145437<svg aria-hidden="true" class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p>
<p>or could just use an external vcxo, but that’s another part (but not <em>that</em> expensive of a part—looks like an appropriate one on digikey for $1.67@qty100)</p>
<h2 id="2024-10-26">2024-10-26<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2024-10-26" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>got i2s working, finally! really hacky driver wrapper at the moment, but it does the job</p>
<h2 id="2024-10-27">2024-10-27<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2024-10-27" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>gonna get dma working for the i2s then introduce rtic</p>
<p>godddd stm32f7xx-hal sucks… i don’t think rust is really a great idea on stm32s…</p></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="toc desktop-only"><button type="button" id="toc" class aria-controls="toc-content" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content"><ul class="overflow"><li class="depth-0"><a href="#raspi-based-prototype" data-for="raspi-based-prototype">RasPi-based prototype</a></li><li class="depth-1"><a href="#hardware" data-for="hardware">Hardware</a></li><li class="depth-1"><a href="#software" data-for="software">Software</a></li><li class="depth-2"><a href="#setting-up-the-pi" data-for="setting-up-the-pi">Setting up the Pi</a></li><li class="depth-2"><a href="#setting-up-pipewire" data-for="setting-up-pipewire">Setting up Pipewire</a></li><li class="depth-0"><a href="#host-audio-drivers" data-for="host-audio-drivers">Host Audio Drivers</a></li><li class="depth-1"><a href="#linux" data-for="linux">Linux</a></li><li class="depth-1"><a href="#macos" data-for="macos">macOS</a></li><li class="depth-2"><a href="#so-im-working-on-my-own" data-for="so-im-working-on-my-own">so i’m working on my own</a></li><li class="depth-1"><a href="#links" data-for="links">Links</a></li><li class="depth-0"><a href="#stm32-based-prototype" data-for="stm32-based-prototype">STM32-based prototype</a></li><li class="depth-1"><a href="#2024-10-12" data-for="2024-10-12">2024-10-12</a></li><li class="depth-1"><a href="#2024-10-13" data-for="2024-10-13">2024-10-13</a></li><li class="depth-1"><a href="#2024-10-14" data-for="2024-10-14">2024-10-14</a></li><li class="depth-1"><a href="#2024-10-19" data-for="2024-10-19">2024-10-19</a></li><li class="depth-1"><a href="#2024-10-25" data-for="2024-10-25">2024-10-25</a></li><li class="depth-1"><a href="#2024-10-26" data-for="2024-10-26">2024-10-26</a></li><li class="depth-1"><a href="#2024-10-27" data-for="2024-10-27">2024-10-27</a></li></ul></div></div> </div></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script type="module">
          let mermaidImport = undefined
          document.addEventListener('nav', async () => {
            if (document.querySelector("code.mermaid")) {
              mermaidImport ||= await import('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs')
              const mermaid = mermaidImport.default
              const darkMode = document.documentElement.getAttribute('saved-theme') === 'dark'
              mermaid.initialize({
                startOnLoad: false,
                securityLevel: 'loose',
                theme: darkMode ? 'dark' : 'default'
              })

              await mermaid.run({
                querySelector: '.mermaid'
              })
            }
          });
          </script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js" type="application/javascript"></script><script src="../postscript.js" type="module"></script></html>